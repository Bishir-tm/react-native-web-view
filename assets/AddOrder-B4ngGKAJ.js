import{u as q,a as F,r as d,A as ae,K as re,j as e,q as g,M as ne,a5 as ce}from"./index-DQeOCy18.js";import{c as A,S as T,X as le,M as oe}from"./Layout-dtLEbaUA.js";import{E as ie}from"./ErrorText-C3VDSOUb.js";import{S as de,M as L,P as U}from"./shopping-cart-54_Ef66u.js";import"./EyeIcon-CIkAS62p.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]],me=A("clipboard",ue);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]],he=A("package",xe);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],R=A("user",pe),V=(c,u)=>{var r;if(!((r=c==null?void 0:c.batches)!=null&&r.length))return{valid:!1,error:"Out of Stock!"};const E=[...c.batches].sort((o,p)=>new Date(o.expiryDate)-new Date(p.expiryDate));let m=u;const v=[];for(const o of E)if(o.quantity>0){const p=Math.min(o.quantity,m);if(p>0&&(v.push({batchNumber:o.batchNumber,allocated:p,expiryDate:o.expiryDate}),m-=p,m<=0))break}if(m>0){const o=u-m;return{valid:!1,error:`Quantity exceeds available stock across all batches. Requested ${u} units but only ${o} available.`}}return{valid:!0,allocations:v}},be=()=>{var z;const c=q(),{products:u,loading:E}=F(t=>t.products),{customers:m,loading:v}=F(t=>t.customers),[r,o]=d.useState({customerId:"",products:[],totalAmount:0}),[p,fe]=d.useState(!1),[O,y]=d.useState(""),[b,w]=d.useState(""),[M,B]=d.useState(!1),[Y,j]=d.useState(!1),[f,_]=d.useState([]),h=d.useRef(null),Q=d.useRef(null);d.useEffect(()=>{c(ae()),c(re())},[c]),d.useEffect(()=>{h.current&&h.current.focus()},[]),d.useEffect(()=>{if(b.trim()===""){_([]),j(!1);return}const t=b.toLowerCase().trim(),a=u.filter(s=>s.name.toLowerCase().includes(t)||s.barcodeOrSku&&s.barcodeOrSku.toLowerCase().includes(t));_(a),j(!0)},[b,u]);const H=t=>{I(t),w(""),j(!1),h.current&&h.current.focus()},K=t=>{if(t.preventDefault(),!b.trim())return;const a=u.find(s=>s.barcodeOrSku===b.trim());a?I(a):f.length===1?I(f[0]):f.length>0?j(!0):c(g({message:`No product found matching: "${b}"`,status:0})),f.length>1||w("")},I=t=>{const a=r.products.findIndex(s=>s.productId===t._id);if(a>=0){const s=S(a,"unitQuantity",(parseInt(r.products[a].unitQuantity)||0)+1);s.isValid||c(g({message:s.error,status:0}))}else{const s={productId:t._id,allocations:[],allocationMessage:"",packQuantity:0,unitQuantity:1,packPrice:t.standardPackPrice,unitPrice:t.standardUnitPrice,totalAmount:t.standardUnitPrice,unitsInPack:t.unitsInPack||1,packQuantityError:"",unitQuantityError:""},n=V(t,1);n.valid?(s.allocations=n.allocations,s.allocationMessage=n.allocations.map(l=>`Batch ${l.batchNumber} (${l.allocated} units, expires: ${new Date(l.expiryDate).toLocaleDateString()})`).join(", "),o({...r,products:[...r.products,s]}),c(g({message:`Added ${t.name} to order`,status:1}))):c(g({message:n.error,status:0}))}},W=t=>{w(t.target.value)};d.useEffect(()=>{const t=a=>{h.current&&!h.current.contains(a.target)&&Q.current&&!Q.current.contains(a.target)&&j(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const X=(t,a,s,i)=>t*s+a*i,S=(t,a,s)=>{const i=r.products[t],n=u.find(N=>N._id===i.productId);if(!n)return{isValid:!1,error:"No product selected"};const l=a==="packQuantity"?parseInt(s)||0:i.packQuantity,x=a==="unitQuantity"?parseInt(s)||0:i.unitQuantity,te=l*(n.unitsInPack||1)+x,P=V(n,te);if(!P.valid)return{isValid:!1,error:P.error};const se=P.allocations.map(N=>`Batch ${N.batchNumber} (${N.allocated} units, expires: ${new Date(N.expiryDate).toLocaleDateString()})`).join(", "),C=[...r.products];return C[t]={...C[t],packQuantity:l,unitQuantity:x,allocations:P.allocations,allocationMessage:se,totalAmount:X(l,x,n.standardPackPrice,n.standardUnitPrice),packQuantityError:"",unitQuantityError:""},o({...r,products:C}),{isValid:!0,error:null}},$=(t,a)=>{const{name:s,value:i}=a.target;if(y(""),s==="productId"){const n=[...r.products],l=u.find(x=>x._id===i);if(!l)return;n[t]={productId:i,allocations:[],allocationMessage:"",packQuantity:0,unitQuantity:0,packPrice:l.standardPackPrice,unitPrice:l.standardUnitPrice,totalAmount:0,unitsInPack:l.unitsInPack||1,packQuantityError:"",unitQuantityError:""},o({...r,products:n}),c(g({message:`Selected product ${l.name}. Prices set.`,status:1}));return}if(s==="packQuantity"||s==="unitQuantity"){const n=S(t,s,i);if(!n.isValid){const l=s==="packQuantity"?"packQuantityError":"unitQuantityError",x=[...r.products];x[t]={...x[t],[l]:n.error},o({...r,products:x})}return}},G=t=>{const a=r.products.filter((s,i)=>i!==t);o({...r,products:a})},D=()=>r.products.reduce((t,a)=>t+(a.totalAmount||0),0),J=t=>{o({...r,customerId:t.target.value}),y("")},k=(t,a,s)=>{const i=r.products[t],n=parseInt(i[a])||0,l=Math.max(0,n+s);S(t,a,l)},Z=()=>{if(r.products.length===0)return y("At least one product is required!");if(r.products.some(s=>s.packQuantity===0&&s.unitQuantity===0))return y("Each product must have either pack or unit quantity!");const t=r.customerId?m.find(s=>s._id===r.customerId):null,a={customerId:r.customerId||null,customerDetails:t||null,products:r.products.map(s=>({unitsInPack:s.unitsInPack,productId:s.productId,allocations:s.allocations,packQuantity:parseInt(s.packQuantity)||0,unitQuantity:parseInt(s.unitQuantity)||0,packPrice:parseFloat(s.packPrice)||0,unitPrice:parseFloat(s.unitPrice)||0,totalAmount:parseFloat(s.totalAmount)||0})),totalAmount:D()};if(a.products.some(s=>s.packPrice<=0||s.unitPrice<=0))return c(g({message:"Invalid price!",status:0})),y("One or more products has its price set to 0!");c(ne({title:"Payment Confirmation",bodyType:oe.PAYMENT_CONFIRMATION,extraObject:a,size:"lg"}))},ee=t=>{const a=u.find(s=>s._id===t);return a?a.name:"Unknown Product"};return e.jsx("div",{className:"flex h-screen bg-base-100 rounded-2xl",children:e.jsxs("div",{className:"flex flex-col w-full",children:[e.jsx("div",{className:"bg-base-100 shadow-md p-4",children:e.jsxs("form",{onSubmit:K,className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{ref:h,type:"text",placeholder:"Search product by name, scan barcode or enter product code...",className:"w-full pl-10 pr-4 py-3 rounded-lg border border-base-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg",value:b,onChange:W,autoFocus:!0}),e.jsx(T,{className:"absolute left-3 top-3 text-gray-400",size:24}),Y&&f.length>0&&e.jsx("div",{ref:Q,className:"absolute z-50 bg-base-100 w-full mt-1 max-h-60 overflow-y-auto rounded-md shadow-lg border border-gray-300",children:f.map(t=>e.jsxs("div",{className:"px-4 py-2 hover:bg-blue-50 cursor-pointer flex justify-between items-center border-b border-gray-100",onClick:()=>H(t),children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:[t.category," ",t.barcodeOrSku&&e.jsxs("span",{className:"text-blue-600",children:["(SKU: ",t.barcodeOrSku,")"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-bold text-blue-700",children:["$",t.standardUnitPrice.toFixed(2)]}),t.unitsInPack>1&&e.jsxs("div",{className:"text-sm text-gray-600",children:["Pack: $",t.standardPackPrice.toFixed(2)]})]})]},t._id))})]}),e.jsx("button",{type:"submit",className:"px-6 py-3 btn btn-primary text-white font-bold rounded-lg",children:"Add Item"}),e.jsxs("button",{type:"button",className:"px-4 py-3 btn btn-secondary rounded-lg flex items-center",onClick:()=>B(!M),children:[e.jsx(R,{size:20,className:"mr-2"}),"Customer"]})]})}),M&&e.jsxs("div",{className:"bg-base-100 shadow-md p-4 border-t border-gray-200",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Select Customer"}),e.jsxs("select",{value:r.customerId,onChange:J,className:"select select-bordered w-full p-2 border rounded-md",disabled:v,children:[e.jsx("option",{value:"",children:"Walk-in Customer"}),m.map(t=>e.jsxs("option",{value:t._id,children:[t.fullname," - ",t.phone||"No Phone"]},t._id))]})]}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsxs("div",{className:"w-2/3 flex flex-col bg-base-100 shadow-md m-4 rounded-lg",children:[e.jsxs("div",{className:"p-4 bg-primary text-white rounded-t-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(de,{size:24,className:"mr-2"}),e.jsx("h2",{className:"text-xl font-bold",children:"Order Items"})]}),r.products.length>0&&e.jsx("button",{className:"text-sm btn btn-danger px-3 py-1 rounded-lg transition",onClick:()=>o({...r,products:[]}),children:"Clear All"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:r.products.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[e.jsx(he,{size:48}),e.jsx("p",{className:"mt-2",children:"No items in order"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Search for a product by name or scan a barcode"})]}):e.jsx("div",{className:"space-y-3",children:r.products.map((t,a)=>e.jsxs("div",{className:"bg-base-100 p-4 rounded-lg border border-base-200",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h3",{className:"font-medium text-lg",children:ee(t.productId)}),e.jsx("button",{className:"p-1 rounded-full hover:bg-red-100 text-red-500",onClick:()=>G(a),children:e.jsx(le,{size:20})})]}),t.allocationMessage&&e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-sm text-blue-800 mb-3",children:[e.jsx("strong",{children:"Allocation:"})," ",t.allocationMessage]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mt-3",children:[t.unitsInPack>1&&e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Pack Qty"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{className:"p-2 rounded-l-md bg-base-200 hover:bg-base-300",onClick:()=>k(a,"packQuantity",-1),children:e.jsx(L,{size:16})}),e.jsx("input",{type:"number",value:t.packQuantity,onChange:s=>$(a,{target:{name:"packQuantity",value:s.target.value}}),className:"p-2 text-center w-16 border-y border-gray-300",min:"0"}),e.jsx("button",{className:"p-2 rounded-r-md bg-base-200 hover:bg-base-300",onClick:()=>k(a,"packQuantity",1),children:e.jsx(U,{size:16})}),e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["$",t.packPrice.toFixed(2)]})]}),t.packQuantityError&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:t.packQuantityError})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Unit Qty"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{className:"p-2 rounded-l-md bg-base-200 hover:bg-base-300",onClick:()=>k(a,"unitQuantity",-1),children:e.jsx(L,{size:16})}),e.jsx("input",{type:"number",value:t.unitQuantity,onChange:s=>$(a,{target:{name:"unitQuantity",value:s.target.value}}),className:"p-2 text-center w-16 border-y border-gray-300",min:"0"}),e.jsx("button",{className:"p-2 rounded-r-md bg-base-200 hover:bg-base-300",onClick:()=>k(a,"unitQuantity",1),children:e.jsx(U,{size:16})}),e.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["$",t.unitPrice.toFixed(2)]})]}),t.unitQuantityError&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:t.unitQuantityError})]}),e.jsx("div",{className:"w-full md:w-auto flex items-end justify-end",children:e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"block text-sm font-medium mb-1",children:"Total"}),e.jsxs("span",{className:"text-lg font-bold text-blue-700",children:["$",t.totalAmount.toFixed(2)]})]})})]})]},a))})})]}),e.jsxs("div",{className:"w-1/3 flex flex-col bg-base-100 shadow-md m-4 ml-0 rounded-lg",children:[e.jsxs("div",{className:"p-4 bg-primary text-white rounded-t-lg flex items-center",children:[e.jsx(me,{size:24,className:"mr-2"}),e.jsx("h2",{className:"text-xl font-bold",children:"Order Summary"})]}),e.jsxs("div",{className:"flex-1 p-4",children:[e.jsxs("div",{className:"bg-base-100 p-4 rounded-lg shadow-sm mb-4",children:[e.jsxs("h3",{className:"font-medium mb-2 flex items-center",children:[e.jsx(R,{size:18,className:"mr-2"}),"Customer"]}),e.jsx("p",{children:r.customerId?((z=m.find(t=>t._id===r.customerId))==null?void 0:z.fullname)||"Selected Customer":"Walk-in Customer"})]}),e.jsxs("div",{className:"bg-base-100 p-4 rounded-lg shadow-sm",children:[e.jsx("h3",{className:"font-medium mb-4",children:"Order Details"}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Items:"}),e.jsx("span",{children:r.products.length})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Units:"}),e.jsx("span",{children:r.products.reduce((t,a)=>t+parseInt(a.unitQuantity||0),0)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Packs:"}),e.jsx("span",{children:r.products.reduce((t,a)=>t+parseInt(a.packQuantity||0),0)})]})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"Total Amount:"}),e.jsxs("span",{className:"text-blue-700",children:["$",D().toFixed(2)]})]})})]})]}),e.jsxs("div",{className:"p-4 bg-base-100 border-t",children:[O&&e.jsx(ie,{children:O}),e.jsx("button",{onClick:Z,className:"w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed mb-2",disabled:r.products.length===0||p,children:"Proceed to Payment"}),e.jsxs("button",{className:"w-full py-2 bg-base-200 hover:bg-base-300 rounded-lg flex items-center justify-center",onClick:()=>h.current.focus(),children:[e.jsx(T,{size:20,className:"mr-2"}),"Back to Search"]})]})]})]})]})})};function ke(){const c=q();return d.useEffect(()=>{c(ce({title:"Add New Order"}))},[]),e.jsx(be,{})}export{ke as default};
