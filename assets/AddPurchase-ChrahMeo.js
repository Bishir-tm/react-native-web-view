import{u as M,a as F,r,G as ne,A as O,j as e,H as ie,q as _,I as oe,a5 as de}from"./index-DQeOCy18.js";import{d as ue,e as me,P as he,B as U,f as B,T as R,D as pe,g as xe,h as $,S as be,i as z,j as fe,k as je,l as Ne,X as ge}from"./Layout-dtLEbaUA.js";import"./ErrorText-C3VDSOUb.js";import"./EyeIcon-CIkAS62p.js";function Pe({closeModal:b}){const d=M(),{suppliers:Q,loading:W}=F(s=>s.suppliers),{products:p,loading:I}=F(s=>s.products),[c,f]=r.useState({purchaseDate:new Date().toISOString().split("T")[0],supplier:"",products:[]}),[P,G]=r.useState({}),[y,S]=r.useState(!1),[k,u]=r.useState(""),[v,j]=r.useState({}),[w,N]=r.useState({}),[C,x]=r.useState({}),h=r.useRef({});r.useEffect(()=>{d(ne()),d(O())},[d]),r.useEffect(()=>{function s(a){Object.keys(h.current).forEach(t=>{h.current[t]&&!h.current[t].contains(a.target)&&h.current[t]&&!h.current[t].contains(a.target)&&x(n=>({...n,[t]:!1}))})}return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[]);const q=s=>{f({...c,[s.target.name]:s.target.value}),u("")},m=(s,a)=>{const t=[...c.products],{name:n,value:i}=a.target,g=t[s].product;if(n==="product"){const l=p.find(o=>o._id===i);t[s]={product:i,category:l.category,standardPackPrice:l.standardPackPrice,standardUnitPrice:l.standardUnitPrice,batchInfo:{batchNumber:"",quantity:1,totalCost:0,packPurchasePrice:0,unitPurchasePrice:0,expiryDate:""}},j(o=>({...o,[s]:!0})),x(o=>({...o,[s]:!1})),N(o=>({...o,[s]:""}))}else if(n.startsWith("standardPrice.")){const l=n.split(".")[1];t[s]={...t[s],[l]:parseFloat(i)||0}}else if(n.startsWith("batchInfo.")){const l=n.split(".")[1],o=["totalCost","quantity"].includes(l)?i===""?"":parseFloat(i):i;if(t[s]={...t[s],batchInfo:{...t[s].batchInfo,[l]:o}},["totalCost","quantity"].includes(l)&&t[s].batchInfo.totalCost&&t[s].batchInfo.quantity){const te=t[s].batchInfo.quantity,ae=t[s].batchInfo.totalCost,L=p.find(re=>re._id===g),ce=L?L.unitsInPack:1,A=ae/te,le=A/ce;t[s].batchInfo.packPurchasePrice=A,t[s].batchInfo.unitPurchasePrice=le}}f({...c,products:t}),u("")},H=(s,a)=>{m(s,{target:{name:"product",value:a}})},V=(s,a)=>{N(t=>({...t,[s]:a})),C[s]||x(t=>({...t,[s]:!0}))},D=s=>{x(a=>({...a,[s]:!a[s]}))},X=s=>{G(a=>({...a,[s]:!a[s]}))},J=s=>{j(a=>({...a,[s]:!a[s]}))},E=()=>{const s=c.products.length;f({...c,products:[...c.products,{product:"",category:"",standardPackPrice:0,standardUnitPrice:0,batchInfo:{batchNumber:"",quantity:1,totalCost:0,packPurchasePrice:0,unitPurchasePrice:0,expiryDate:""}}]}),j(a=>({...a,[s]:!0})),N(a=>({...a,[s]:""}))},K=s=>{const a=c.products.filter((g,l)=>l!==s);f({...c,products:a});const t={...v};delete t[s];const n={...w};delete n[s],N(n);const i={...C};delete i[s],x(i),Object.keys(t).forEach(g=>{const l=parseInt(g);l>s&&(t[l-1]=t[l],delete t[l])}),j(t)},Y=()=>{if(!c.supplier)return u("Supplier is required!");const s=c.products.filter(t=>t.product);if(s.length===0)return u("At least one product is required!");for(const t of s){if(!t.batchInfo.quantity||t.batchInfo.quantity<=0)return u("Quantity is required and must be greater than 0 for all products.");if(!t.batchInfo.totalCost||t.batchInfo.totalCost<=0)return u("Total Cost is required and must be greater than 0 for all products.");if(!t.batchInfo.expiryDate)return u("Expiry date is required for all products.")}const a={...c,products:s};S(!0),d(ie(a)).unwrap().then(()=>{d(_({message:"Purchase added successfully!",status:1})),d(O()),d(oe()),b()}).catch(t=>{d(_({message:t.message,status:0})),u(t.message)}).finally(()=>S(!1))},Z=s=>{const a=p.find(t=>t._id===s);return a?a.name:"Select a product"},ee=()=>c.products.reduce((s,a)=>s+(a.batchInfo.totalCost||0),0),se=()=>c.products.reduce((s,a)=>s+(a.batchInfo.quantity||0),0),T=s=>{const a=w[s]||"";return a.trim()?p.filter(t=>t.name.toLowerCase().includes(a.toLowerCase())||t.category.toLowerCase().includes(a.toLowerCase())):p};return e.jsxs("div",{className:"modal-content bg-base-100 rounded-lg",children:[e.jsx("div",{className:"bg-primary text-primary-content p-6 rounded-t-lg",children:e.jsxs("h2",{className:"text-2xl font-bold flex items-center",children:[e.jsx(ue,{className:"mr-2"}),"New Purchase Order"]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"bg-base-200 rounded-xl p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm opacity-70",children:"Order Date"}),e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),e.jsx("input",{type:"date",id:"purchaseDate",name:"purchaseDate",value:c.purchaseDate,onChange:q,className:"input input-sm input-bordered w-full"})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm opacity-70",children:"Supplier"}),e.jsxs("div",{className:"relative flex items-center mt-1",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none",children:e.jsx(he,{className:"w-4 h-4"})}),e.jsxs("select",{id:"supplier",name:"supplier",value:c.supplier,onChange:q,className:"select select-sm select-bordered pl-10 w-full",disabled:W,children:[e.jsx("option",{value:"",children:"Select a Supplier"}),Q.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm opacity-70",children:"Summary"}),e.jsxs("div",{className:"flex items-center justify-between mt-1 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Total Cost:"}),e.jsxs("span",{className:"font-bold",children:["₦",ee().toLocaleString()]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Total Items:"}),e.jsxs("span",{className:"font-bold",children:[se()," packs"]})]})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center",children:[e.jsx(U,{className:"mr-2"}),"Products"]}),e.jsxs("button",{onClick:E,className:"btn btn-sm btn-primary",children:[e.jsx(B,{className:"w-4 h-4 mr-1"})," Add Product"]})]}),c.products.length===0?e.jsxs("div",{className:"text-center py-8 bg-base-200 rounded-lg",children:[e.jsx(U,{className:"mx-auto w-12 h-12 opacity-30"}),e.jsx("p",{className:"mt-2 text-base-content opacity-60",children:"No products added yet"}),e.jsxs("button",{onClick:E,className:"btn btn-sm btn-primary mt-4",children:[e.jsx(B,{className:"w-4 h-4 mr-1"})," Add First Product"]})]}):e.jsx("div",{className:"space-y-4 flex flex-col-reverse",children:c.products.map((s,a)=>e.jsxs("div",{className:"bg-base-200 rounded-xl overflow-hidden border border-base-300",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between cursor-pointer",onClick:()=>J(a),children:[e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsx("span",{className:"bg-primary text-primary-content w-8 h-8 rounded-full flex items-center justify-center mr-3",children:a+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:s.product?Z(s.product):`Product ${a+1}`}),s.product&&e.jsxs("div",{className:"flex text-sm opacity-70 mt-1",children:[e.jsxs("span",{className:"flex items-center mr-4",children:[e.jsx(R,{className:"w-3 h-3 mr-1"})," ",s.category||"No category"]}),e.jsxs("span",{className:"flex items-center",children:[e.jsx(pe,{className:"w-3 h-3 mr-1"}),s.batchInfo.totalCost?`₦${s.batchInfo.totalCost.toLocaleString()}`:"₦0"]})]})]})]}),e.jsx("div",{className:"flex items-center",children:v[a]?e.jsx(xe,{className:"w-5 h-5"}):e.jsx($,{className:"w-5 h-5"})})]}),v[a]&&e.jsxs("div",{className:"border-t border-base-300 p-4 bg-base-100",ref:t=>h.current[a]=t,children:[e.jsxs("div",{className:"form-control mb-4",children:[e.jsx("label",{className:"label",children:e.jsx("span",{className:"label-text font-medium",children:"Product"})}),e.jsx("div",{className:"relative",children:e.jsx("div",{className:"flex",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none",children:e.jsx(be,{className:"w-4 h-4 text-gray-500"})}),e.jsx("input",{type:"text",className:"input input-bordered w-full pl-10 pr-10",placeholder:"Search products...",value:w[a]||"",onChange:t=>V(a,t.target.value),onClick:()=>D(a),disabled:I}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3",children:e.jsx("button",{type:"button",onClick:()=>D(a),children:e.jsx($,{className:"w-4 h-4"})})})]})})})]}),C[a]&&e.jsx("div",{className:"absolute z-40 mt-1 w-full bg-base-100 shadow-lg max-h-60 rounded-md overflow-auto",children:I?e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("span",{className:"loading loading-spinner loading-sm"})," ","Loading..."]}):T(a).length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"No products found"}):e.jsx("ul",{className:"py-1 z-20",children:T(a).map(t=>e.jsxs("li",{className:`px-4 py-2 hover:bg-base-200 cursor-pointer ${s.product===t._id?"bg-primary/10":""}`,onClick:()=>H(a,t._id),children:[e.jsx("div",{className:"font-medium",children:t.name}),e.jsxs("div",{className:"text-xs opacity-70 flex items-center",children:[e.jsx(R,{className:"w-3 h-3 mr-1"})," ",t.category]})]},t._id))})}),s.product&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 bg-base-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-medium",children:"Standard Selling Prices"}),e.jsx("button",{onClick:()=>X(s.product),className:"btn btn-xs btn-ghost",children:P[s.product]?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"w-3 h-3 mr-1"})," Save"]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"w-3 h-3 mr-1"})," Edit"]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs opacity-70",children:"Pack Selling Price (₦)"}),e.jsx("input",{type:"number",name:"standardPrice.standardPackPrice",value:s.standardPackPrice||0,onChange:t=>m(a,t),disabled:!P[s.product],className:"input input-sm input-bordered w-full mt-1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs opacity-70",children:"Unit Selling Price (₦)"}),e.jsx("input",{type:"number",name:"standardPrice.standardUnitPrice",value:s.standardUnitPrice||0,onChange:t=>m(a,t),disabled:!P[s.product],className:"input input-sm input-bordered w-full mt-1"})]})]})]}),e.jsx("h4",{className:"font-medium mb-3",children:"Batch Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"form-control mb-3",children:[e.jsx("label",{className:"label",children:e.jsx("span",{className:"label-text text-xs opacity-70",children:"Batch Number"})}),e.jsx("input",{type:"text",name:"batchInfo.batchNumber",value:s.batchInfo.batchNumber,onChange:t=>m(a,t),className:"input input-sm input-bordered w-full",placeholder:"Auto-generated if empty"})]}),e.jsxs("div",{className:"form-control mb-3",children:[e.jsx("label",{className:"label",children:e.jsx("span",{className:"label-text text-xs opacity-70",children:"Quantity (Packs)"})}),e.jsx("input",{type:"number",name:"batchInfo.quantity",value:s.batchInfo.quantity,onChange:t=>m(a,t),className:"input input-sm input-bordered w-full",min:1})]}),e.jsxs("div",{className:"form-control mb-3",children:[e.jsx("label",{className:"label",children:e.jsx("span",{className:"label-text text-xs opacity-70",children:"Total Cost (₦)"})}),e.jsx("input",{type:"number",name:"batchInfo.totalCost",value:s.batchInfo.totalCost,onChange:t=>m(a,t),className:"input input-sm input-bordered w-full",min:0})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"form-control mb-3",children:[e.jsx("label",{className:"label",children:e.jsx("span",{className:"label-text text-xs opacity-70",children:"Purchase Price per Pack (₦)"})}),e.jsx("input",{type:"number",value:s.batchInfo.packPurchasePrice.toFixed(2),className:"input input-sm input-bordered w-full bg-base-200",disabled:!0})]}),e.jsxs("div",{className:"form-control mb-3",children:[e.jsx("label",{className:"label",children:e.jsx("span",{className:"label-text text-xs opacity-70",children:"Purchase Price per Unit (₦)"})}),e.jsx("input",{type:"number",value:s.batchInfo.unitPurchasePrice.toFixed(2),className:"input input-sm input-bordered w-full bg-base-200",disabled:!0})]}),e.jsxs("div",{className:"form-control mb-3",children:[e.jsx("label",{className:"label",children:e.jsx("span",{className:"label-text text-xs opacity-70",children:"Expiry Date"})}),e.jsx("input",{type:"date",name:"batchInfo.expiryDate",value:s.batchInfo.expiryDate,onChange:t=>m(a,t),className:"input input-sm input-bordered w-full"})]})]})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs("button",{onClick:()=>K(a),className:"btn btn-sm btn-outline btn-error",children:[e.jsx(je,{className:"w-4 h-4 mr-1"})," Remove Product"]})})]})]})]},a))})]}),k&&e.jsxs("div",{className:"alert alert-error mb-4",children:[e.jsx(Ne,{className:"w-5 h-5"}),e.jsx("span",{children:k})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsxs("button",{onClick:b,className:"btn btn-ghost",children:[e.jsx(ge,{className:"w-4 h-4 mr-1"})," Cancel"]}),e.jsxs("button",{onClick:Y,className:`btn btn-primary ${y?"loading":""}`,disabled:y,children:[y?e.jsx("span",{className:"loading loading-spinner loading-sm mr-1"}):e.jsx(z,{className:"w-4 h-4 mr-1"}),"Save Purchase"]})]})]})]})}function Ie(){const b=M();return r.useEffect(()=>{b(de({title:"Add New Order"}))},[]),e.jsx(Pe,{})}export{Ie as default};
